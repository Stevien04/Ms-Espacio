<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestion de Espacios</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f5f5f5; }
        h1 { color: #0b5394; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
        th { background-color: #0b5394; color: #fff; }
        form { background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        label { display: block; margin-top: 0.75rem; }
        input, select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
        button { margin-top: 1rem; padding: 0.75rem 1rem; background-color: #0b5394; color: #fff; border: none; cursor: pointer; }
        .mensaje { margin-top: 1rem; font-weight: bold; }
    </style>
</head>
<body>
<h1>Listado de Espacios</h1>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Codigo</th>
        <th>Nombre</th>
        <th>Tipo</th>
        <th>Capacidad</th>
        <th>Equipamiento</th>
        <th>Estado</th>
        <th>ID Escuela</th>
        <th>Escuela</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="espacio : ${espacios}">
        <td th:text="${espacio.id}">1</td>
        <td th:text="${espacio.codigo}">COD-001</td>
        <td th:text="${espacio.nombre}">Laboratorio de Sistemas</td>
        <td th:text="${espacio.tipo}">Laboratorio</td>
        <td th:text="${espacio.capacidad}">30</td>
        <td th:text="${espacio.equipamiento}">PCs, proyectores</td>
        <td th:text="${espacio.estado}">1</td>
        <td th:text="${espacio.escuelaId}">2</td>
        <td th:text="${espacio.escuelaNombre}">Ing. de Sistemas</td>
    </tr>
    </tbody>
</table>

<h2>Crear nuevo espacio</h2>
<form id="crearEspacioForm">
    <label for="codigo">Codigo</label>
    <input id="codigo" name="codigo" maxlength="20" required>

    <label for="nombre">Nombre</label>
    <input id="nombre" name="nombre" maxlength="100" required>

    <label for="tipo">Tipo</label>
    <select id="tipo" name="tipo" required>
        <option value="Laboratorio">Laboratorio</option>
        <option value="Salon">Salon</option>
    </select>

    <label for="capacidad">Capacidad</label>
    <input id="capacidad" name="capacidad" type="number" min="1" required>

    <label for="equipamiento">Equipamiento</label>
    <textarea id="equipamiento" name="equipamiento" rows="3"></textarea>

    <label for="estado">Estado (1=Activo, 0=Inactivo)</label>
    <input id="estado" name="estado" type="number" min="0" max="1" value="1">

    <label for="escuelaId">Escuela</label>
    <select id="escuelaId" name="escuelaId" required>
        <option value="" disabled selected>Seleccione una escuela</option>
        <option th:each="escuela : ${escuelas}"
                th:value="${escuela.id}"
                th:text="${escuela.nombre}">Escuela</option>
    </select>

    <button type="submit">Guardar</button>
    <div id="mensaje" class="mensaje"></div>
</form>

<script>
    const form = document.getElementById('crearEspacioForm');
    const mensaje = document.getElementById('mensaje');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        mensaje.textContent = 'Guardando...';

        const payload = {
            codigo: form.codigo.value,
            nombre: form.nombre.value,
            tipo: form.tipo.value,
            capacidad: Number(form.capacidad.value),
            equipamiento: form.equipamiento.value,
            estado: form.estado.value ? Number(form.estado.value) : 1,
            escuelaId: Number(form.escuelaId.value)
        };

        try {
            const response = await fetch('/api/espacios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || error.error || 'No se pudo guardar el espacio');
            }

            mensaje.textContent = 'Espacio creado correctamente, recargando...';
            setTimeout(() => window.location.reload(), 800);
        } catch (error) {
            mensaje.textContent = error.message;
        }
    });
</script>
</body>
</html>
